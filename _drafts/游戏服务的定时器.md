

*前四篇文章介绍了系统的定时器设计，用户层的游戏服务器定时器又应该怎样设计呢？*

在游戏服务器的设计中，定时器是必不可少的一个组件。
游戏中很多逻辑都涉及到计时，例如RPG游戏战斗中计算角色的buff、debuff，技能的CD或是在休闲类游戏中的倒计时等等。
在网络游戏中，这类计时一般都是在服务端计算，然后同步到客户端。
另外服务端主动向客户端发起的请求大多是由定时器发起的。

### 游戏服务器的计时架构

看过前面四篇文章后，我们很自然的想到游戏服务器的计时架构应该和系统的计时架构类似：
**在固定的时间间隔检查是否有定时器到期，如果有定时器到期则做出相应的处理**。
原理大致相同，实现上则有所不同。
系统的计时架构有硬件的支撑，固定的时间间隔是由固定频率的定时器发起时钟中断激活。  
游戏服务器的计时架构实现则是百花齐放，其具体的实现需要依据游戏服务器的设计，下面列举几种获取固定时间间隔的常见方式：

-   子线程计时，主线程处理。

    通过子线程发起消息通知或者信号量使主线程获得固定时间间隔。
这种方式类似系统的计时架构，用子线程来模拟硬件，优点是主线程可以获得稳定的时间间隔。

-   主线程计时，主线程处理。

    在主线程大循环内通过系统调用获取时间计算出固定的时间间隔。
这种方式设计上比较简洁，游戏服务器的设计使用单线程即可，
缺点是如果主循环因处理业务逻辑阻塞，定时器则获取不到执行权，可能会影响固定时间间隔的精度。

-   子线程计时，子线程处理。

    可以和上面一种做法相同，或是子线程使用定时器函数获取固定的时间间隔。
这种方式在处理业务逻辑上就比较复杂了，需要处理线程间的数据共享问题。

### 游戏服务器的定时器

定时器的设计思路

1.  操作

2.  高效

    这个应该是定时器设计的共同目标，减少执行流的耗时，把更多的性能留给业务。

3.  随内核

    应该是至少是随内核，如果进程需要重启，定时器不会被影响。如果定时器被销毁，对于一些业务逻辑来说，是毁灭性的打击。

4.  可以调时间

    这是一个比较特殊的需求，一般的业务是不需要可以调时间的。在游戏服务器的设计中，计时架构能调整时间对测试是一个很重要的功能。