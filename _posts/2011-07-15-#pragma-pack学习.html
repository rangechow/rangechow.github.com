---
layout: post
title: '#pragma pack学习'
---


                                                
                                                <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; &nbsp;&nbsp;<span style="font-family: 宋体">最近调试网络的服务端程序，自己写了一个小客户端程序来测试，发现服务程序解包错误。经调试发现客户端的协议头大小和服务器端的协议头大
                                                        
                                                        
                                                        小不一致。原因是服务器端加了</span>#pragma pack(1),<span style="font-family: 宋体">而客户端没加。</span></p>
                                                 <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; 之前没接触过这个编译宏，现在来认真学习之。</span></p
                                                 
                                                 
                                                 >
                                                  <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; 首先</span>google<span style="font-family: 宋体">之</span>~~</p>
                                                   <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; 原来</span>#pragma pack<span style="font-family: 宋体">有几种形式，我所接触到的是</span>#pragma pack(n)<span style="font-family: 宋体">，即变量以</span>n<span style="font-family: 宋体">字节对齐。</span></p>
                                                    <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; 变量对齐在每个系统中是不一样的，默认的对齐方式能有效的提高</span>cpu<span style="font-family: 宋体">取指取数的速度，但是可能会浪费一定的空间。在网络程序中采用</span>#pragma pack(1),<span style="font-family: 宋体">即变量紧缩，</span><span style="background-color: #ff6600; font-family: 宋体">不但可以减少网络流量，还可以兼容各种系统，不会因为系统对齐方式不同而导致解包错误。</span></p>
                                                     <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; 了解了概念和优点，现在我们就来测试之</span>~</p>
                                                      <p style="text-indent: 0px; margin: 5px auto">&nbsp;</p>
                                                       <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; 平台：</span>CPU&#8212;Pentium E5700&nbsp;<span style="font-family: 宋体">内存</span>&#8212;2G</p>
                                                        <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; &nbsp;1.<span style="font-family: 宋体">操作系统：</span><span>ubuntu 11.04 32bit&nbsp;&nbsp;&nbsp;</span><span style="font-family: 宋体">编译器：</span>G++ 4.5.2</p>
                                                         <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; &nbsp;2.<span style="font-family: 宋体">操作系统：</span>windows xp<span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="font-family: 宋体">编译器：VS2010</span></p>
                                                          <p style="text-indent: 0px; margin: 5px auto">&nbsp;</p>
                                                           <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; 先看第一个测试。</span></p>
                                                            <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; 结构体在正常情况和紧缩情况在以上不同环境下占用的内存大小。</span></p>
                                                             <p style="text-indent: 0px; margin: 5px auto"><font class="Apple-style-span" size="3"></font></p>
                                                              <div style="border-bottom: #cccccc 1px solid; border-left: #cccccc 1px solid; padding-bottom: 4px; background-color: #eeeeee; padding-left: 4px; width: 1074px; padding-right: 5px; font-size: 13px; word-break: break-all; border-top: #cccccc 1px solid; border-right: #cccccc 1px solid; padding-top: 4px"><font class="Apple-style-span" size="3"><span style="color: #008080">1</span>&nbsp;<span style="color: #0000ff">struct</span><span style="color: #000000">&nbsp;pack&nbsp;{<br /></span><span style="color: #008080">2</span>&nbsp;<span style="color: #000000">&nbsp;&nbsp;</span><span style="color: #0000ff">int</span><span style="color: #000000">&nbsp;i;<br /></span><span style="color: #008080">3</span>&nbsp;<span style="color: #000000">&nbsp;&nbsp;</span><span style="color: #0000ff">short</span><span style="color: #000000">&nbsp;s;<br /></span><span style="color: #008080">4</span>&nbsp;<span style="color: #000000">&nbsp;&nbsp;</span><span style="color: #0000ff">double</span><span style="color: #000000">&nbsp;d;<br /></span><span style="color: #008080">5</span>&nbsp;<span style="color: #000000">&nbsp;&nbsp;</span><span style="color: #0000ff">char</span><span style="color: #000000">&nbsp;c;<br /></span><span style="color: #008080">6</span>&nbsp;<span style="color: #000000">&nbsp;&nbsp;</span><span style="color: #0000ff">short</span><span style="color: #000000">&nbsp;f;<br /></span><span style="color: #008080">7</span>&nbsp;<span style="color: #000000">}</span></font></div>
                                                               <p style="text-indent: 0px; margin: 5px auto"></p>
                                                                <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp;&nbsp;<br />&nbsp; &nbsp;测试结果为：</span></p>
                                                                 <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; 1<span style="font-family: 宋体">：<br />&nbsp; &nbsp;<img alt="" src="http://www.cppblog.com/images/cppblog_com/range/12.jpg" width="400" height="52" /></span></p>
                                                                  <p style="text-indent: 0px; margin: 5px auto">&nbsp;</p>
                                                                   <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; 2<span style="font-family: 宋体">：<br /></span>&nbsp; &nbsp;&nbsp;<img alt="" src="http://www.cppblog.com/images/cppblog_com/range/13.jpg" width="401" height="50" /><br /><span style="font-family: 宋体" class="Apple-style-span">&nbsp;&nbsp;</span><span style="font-family: 宋体" class="Apple-style-span"><br /></span><span style="font-family: 宋体" class="Apple-style-span">&nbsp; &nbsp; 测试结果分析：</span></p>
                                                                    <p style="text-indent: 0px; margin: 5px auto">&nbsp;</p>
                                                                     <p style="text-indent: 0px; margin: 5px auto">&nbsp;</p>
                                                                      <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; 可以看出紧缩后结构体的大小为</span>15<span style="font-family: 宋体">，是结构体内置类型大小的和。但是在默认情况下，结构体的大小都是对齐字节数的倍数。</span>ubuntu<span style="font-family: 宋体">下</span>pack<span style="font-family: 宋体">只需要</span>20<span style="font-family: 宋体">个字节，而</span>windows<span style="font-family: 宋体">要</span>24<span style="font-family: 宋体">个字节。这是因为</span>ubuntu<span style="font-family: 宋体">是以</span>4<span style="font-family: 宋体">字节对齐，而</span>windows<span style="font-family: 宋体">则是以最大的内置类型的字节数对齐，在结构体内最大的内置类型为</span>double<span style="font-family: 宋体">，其大小为</span>8<span style="font-family: 宋体">个字节。他们在内存中的对齐方式如下图：</span></p>
                                                                       <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; 1<span style="font-family: 宋体">：</span></p>
                                                                        <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp;&nbsp;<img alt="" src="http://www.cppblog.com/images/cppblog_com/range/3.jpg" width="691" height="244" /></p>
                                                                         <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; 2<span style="font-family: 宋体">：</span></p>
                                                                          <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp;&nbsp;<img alt="" src="http://www.cppblog.com/images/cppblog_com/range/4.jpg" width="681" height="281" /></p>
                                                                           <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp;还需注意的是，</span><span style="background-color: #ff6600; font-family: 宋体">在对齐类型的内部都是以</span><span style="background-color: #ff6600">2</span><span style="background-color: #ff6600; font-family: 宋体">字节对齐的。</span></p>
                                                                            <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp;结论：</span><span style="background-color: #ff6600; font-family: 宋体">在默认情况下，</span><span style="background-color: #ff6600">linux</span><span style="background-color: #ff6600; font-family: 宋体">操作系统是以</span><span style="background-color: #ff6600">4</span><span style="background-color: #ff6600; font-family: 宋体">字节对齐，</span><span style="background-color: #ff6600">windows</span><span style="background-color: #ff6600; font-family: 宋体">操作系统则是以最大的内置类型对齐。</span></p>
                                                                             <p style="text-indent: 0px; margin: 5px auto">&nbsp;</p>
                                                                              <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp;第二个测试</span></p>
                                                                               <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp;一个结构体内包含另外一个结构体，其大小的情况。</span></p>
                                                                                <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp;内部的结构体为</span></p>
                                                                                 <p style="text-align: left; text-indent: 0px; margin: 5px auto" align="left"><font class="Apple-style-span" size="3"></font></p>
                                                                                  <div style="border-bottom: #cccccc 1px solid; border-left: #cccccc 1px solid; padding-bottom: 4px; background-color: #eeeeee; padding-left: 4px; width: 1074px; padding-right: 5px; font-size: 13px; word-break: break-all; border-top: #cccccc 1px solid; border-right: #cccccc 1px solid; padding-top: 4px"><font class="Apple-style-span" size="3"><span style="color: #008080">1</span>&nbsp;<span style="color: #0000ff">struct</span><span style="color: #000000">&nbsp;pack&nbsp;{<br /></span><span style="color: #008080">2</span>&nbsp;<span style="color: #000000">&nbsp;&nbsp;</span><span style="color: #0000ff">short</span><span style="color: #000000">&nbsp;s;<br /></span><span style="color: #008080">3</span>&nbsp;<span style="color: #000000">&nbsp;&nbsp;</span><span style="color: #0000ff">double</span><span style="color: #000000">&nbsp;d;<br /></span><span style="color: #008080">4</span>&nbsp;<span style="color: #000000">}</span></font></div>
                                                                                   <p style="text-indent: 0px; margin: 5px auto"></p>
                                                                                    <p style="text-align: left; text-indent: 0px; margin: 5px auto" align="left"><span style="font-family: 宋体">&nbsp; &nbsp;外部的结构体为</span></p>
                                                                                     <p style="text-align: left; text-indent: 12pt; margin: 5px auto" align="left"><span style="font-size: 12pt">&nbsp; &nbsp;</span><span style="font-size: 13px" class="Apple-style-span"><span style="color: #008080">1</span></span><span style="font-size: 13px" class="Apple-style-span">&nbsp;</span><span style="font-size: 13px" class="Apple-style-span"><span style="color: #0000ff">struct</span></span><span style="font-size: 13px" class="Apple-style-span"><span style="color: #000000">&nbsp;complex&nbsp;_pack{</span></span></p>
                                                                                      <div style="border-bottom: #cccccc 1px solid; border-left: #cccccc 1px solid; padding-bottom: 4px; background-color: #eeeeee; padding-left: 4px; width: 1074px; padding-right: 5px; font-size: 13px; word-break: break-all; border-top: #cccccc 1px solid; border-right: #cccccc 1px solid; padding-top: 4px"><span style="color: #008080">2</span>&nbsp;<span style="color: #000000">&nbsp;&nbsp;</span><span style="color: #0000ff">char</span><span style="color: #000000">&nbsp;c;<br /></span><span style="color: #008080">3</span>&nbsp;<span style="color: #000000">&nbsp;&nbsp;</span><span style="color: #0000ff">struct</span><span style="color: #000000">&nbsp;pack&nbsp;s;<br /></span><span style="color: #008080">4</span>&nbsp;<span style="color: #000000">&nbsp;&nbsp;</span><span style="color: #0000ff">double</span><span style="color: #000000">&nbsp;d;<br /></span><span style="color: #008080">5</span>&nbsp;<span style="color: #000000">};</span></div>
                                                                                       <p style="text-align: left; text-indent: 0px; margin: 5px auto" align="left"><span style="font-family: 宋体; font-size: 12pt">&nbsp; &nbsp; 我们有四种情况：</span></p>
                                                                                        <p style="text-align: left; text-indent: -18pt; margin: 5px auto 5px 18pt" align="left"><span style="font-size: 12pt"><span>&nbsp; &nbsp; &nbsp;1.<span style="font: 7pt 'Times New Roman'">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span><span style="font-size: 12pt">pack</span><span style="font-family: 宋体; font-size: 12pt">紧缩，</span><span style="font-size: 12pt">complex _pack</span><span style="font-family: 宋体; font-size: 12pt">紧缩</span></p>
                                                                                         <p style="text-align: left; text-indent: -18pt; margin: 5px auto 5px 18pt" align="left"><span style="font-size: 12pt"><span>&nbsp; &nbsp; &nbsp;2.<span style="font: 7pt 'Times New Roman'">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span><span style="font-size: 12pt">pack</span><span style="font-family: 宋体; font-size: 12pt">紧缩，</span><span style="font-size: 12pt">complex _pack</span><span style="font-family: 宋体; font-size: 12pt">默认</span></p>
                                                                                          <p style="text-align: left; text-indent: -18pt; margin: 5px auto 5px 18pt" align="left"><span style="font-size: 12pt"><span>&nbsp; &nbsp; &nbsp;3.<span style="font: 7pt 'Times New Roman'">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span><span style="font-size: 12pt">pack</span><span style="font-family: 宋体; font-size: 12pt">默认，</span><span style="font-size: 12pt">complex _pack</span><span style="font-family: 宋体; font-size: 12pt">紧缩</span></p>
                                                                                           <p style="text-align: left; text-indent: -18pt; margin: 5px auto 5px 18pt" align="left"><span style="font-size: 12pt"><span>&nbsp; &nbsp; &nbsp;4.<span style="font: 7pt 'Times New Roman'">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span><span style="font-size: 12pt">pack</span><span style="font-family: 宋体; font-size: 12pt">默认，</span><span style="font-size: 12pt">complex _pack</span><span style="font-family: 宋体; font-size: 12pt">默认</span></p>
                                                                                            <p style="text-align: left; text-indent: 0px; margin: 5px auto" align="left"><span style="font-family: 宋体; font-size: 12pt">&nbsp; &nbsp; 以下的排列均按此顺序。</span></p>
                                                                                             <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; &nbsp;测试的结果</span></p>
                                                                                              <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; &nbsp; 1<span style="font-family: 宋体">：</span></p>
                                                                                               <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; &nbsp;&nbsp;<img alt="" src="http://www.cppblog.com/images/cppblog_com/range/6.jpg" width="430" height="307" /></p>
                                                                                                <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; &nbsp;2<span style="font-family: 宋体">：</span></p>
                                                                                                 <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; &nbsp;&nbsp;<img alt="" src="http://www.cppblog.com/images/cppblog_com/range/5.jpg" width="432" height="294" /></p>
                                                                                                  <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; 测试结果分析：</span></p>
                                                                                                   <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; 在两个操作系统下，除了第一种情况</span>----<span style="font-family: 宋体">内结构体和外结构体都紧缩</span>----<span style="font-family: 宋体">相同之外，其他三种情况都不相同。我们可以根据偏移画出结构体在内存中的情况。第一种情况省略。</span></p>
                                                                                                    <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; &nbsp;1<span style="font-family: 宋体">：</span></p>
                                                                                                     <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; &nbsp;<img alt="" src="http://www.cppblog.com/images/cppblog_com/range/7.jpg" width="400" height="456" /></p>
                                                                                                      <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; &nbsp;2<span style="font-family: 宋体">：</span></p>
                                                                                                       <p style="text-indent: 0px; margin: 5px auto">&nbsp; &nbsp; &nbsp;<img alt="" src="http://www.cppblog.com/images/cppblog_com/range/8.jpg" width="368" height="555" /></p>
                                                                                                        <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; 结论：</span>#pragma pack<span style="font-family: 宋体">只影响当前结构体的变量的对齐情况，并不会影响结构体内部的结构体变量的排列情况。或者说</span><span style="background-color: #ff6600">#pragma pack</span><span style="background-color: #ff6600; font-family: 宋体">的作用域只是一层</span><span style="font-family: 宋体">。我们由第三种情况，内部结构体正常，外部结构体紧缩，可以得出结构体的对齐是按偏移计算的。</span></p>
                                                                                                         <p style="text-indent: 0px; margin: 5px auto"><span style="font-family: 宋体">&nbsp; &nbsp; 这里还有一个问题没解决，为什么第二种情况内部结构体的偏移都是</span>1?不是4或者8？</p>
                                                                                                          <p style="text-indent: 0px; margin: 5px auto">&nbsp;</p><img src ="http://www.cppblog.com/range/aggbug/151094.html" width = "1" height = "1" /><br><br><div align=right><a style="text-decoration:none;" href="http://www.cppblog.com/range/" target="_blank">Range</a> 2011-07-15 20:36 <a href="http://www.cppblog.com/range/archive/2011/07/15/151094.html#Feedback" target="_blank" style="text-decoration:none;">发表评论</a></div>
                                                                                                                  
                                                                                                              
