---
layout: post
title: NAT学习
---


                                                                                                                  
                                                                                                                  <p style="margin-top: 5px; margin-right: auto; margin-bottom: 5px; margin-left: auto; text-indent: 0px; ">&nbsp; &nbsp; &nbsp; The IP Network Address Translator<span style="font-family: 宋体; ">，</span>IP<span style="font-family: 宋体; ">网络地址转换是人们说的</span>NAT<span style="
                                                                                                                          
                                                                                                                          
                                                                                                                          font-family: 宋体; ">，或者说</span>NA(P)T<span style="font-family: 宋体; ">。</span>NAT<span style="font-family: 宋体; ">是为了解决</span>IPv4<span style="font-family: 宋体; ">地址不足而提出来得一种替代方案，可以对外界屏蔽内部的网络拓扑。随着网络的发展，</span>NAT<span style="font-family: 宋体; ">阻碍了构建在覆盖网络的</span>P2P<span style="font-family: 宋体; ">程序的发展。因为覆盖网络是构建在应用层，屏蔽了传输层以下的网络拓扑，网络中的每一个节点或某些节点有此网络的路由表，由这些路由表构建出这个覆盖网络，但是</span>NAT<span style="font-family: 宋体; ">阻碍的覆盖网络中节点的连接。<br />&nbsp; &nbsp;&nbsp;<br />&nbsp; &nbsp;&nbsp;<img src="http://www.cppblog.com/images/cppblog_com/range/9.jpg" width="541" height="337" alt="" /><br />&nbsp; &nbsp;<br />&nbsp; &nbsp;&nbsp;</span><span style="font-family: 宋体; ">上图显示了</span>NAT<span style="font-family: 宋体; ">的原理。</span>NAT<span style="font-family: 宋体; ">将内网的</span>IP<span style="font-family: 宋体; ">替换为公网</span>IP<span style="font-family: 宋体; ">，将端口映射为公网的端口。公网</span>IP<span style="font-family: 宋体; ">替换内网</span>IP<span style="font-family: 宋体; ">是固定的，</span>NAT<span style="font-family: 宋体; ">的不足之处在于端口的替换。因为</span>NAT<span style="font-family: 宋体; ">还没有形成标准，替换策略有几种，这也是</span>NAT<span style="font-family: 宋体; ">行为的关键。</span></p><div style="padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "><p style="margin-top: 5px; margin-right: auto; margin-bottom: 5px; margin-left: auto; text-indent: 0px; "><span style="font-family: 宋体; ">&nbsp; &nbsp; &nbsp;在《</span><span>Behavior and Classification of NAT Devices and Implications for NAT Traversal</span><span style="font-family: 宋体; ">》一文中就把端口映射的行为分成四种，其中包括保留端口，不保留端口，端口重载，端口复用。这四种分类最终区分了</span>NAT<span style="font-family: 宋体; ">的四种类型即</span>Full cone NAT<span style="font-family: 宋体; ">，</span>Symmetric NAT<span style="font-family: 宋体; ">，</span>Port-Restrictes cone NAT&nbsp;<span style="font-family: 宋体; ">，</span><span>Address-Restriced cone NAT</span><span style="font-family: 宋体; ">。</span></p><p style="margin-top: 5px; margin-right: auto; margin-bottom: 5px; margin-left: auto; text-indent: 0px; "><span style="font-family: 宋体; ">&nbsp; &nbsp; &nbsp;为了使覆盖网络中的节点相互通信，我们需要进行</span>NAT<span style="font-family: 宋体; ">穿越。在《</span>A NAT Traversal Mechanism for Peer-To-Peer Networks<span style="font-family: 宋体; ">》一文种介绍了根据两端不同的</span>NAT<span style="font-family: 宋体; ">类型对应的四种</span>NAT<span style="font-family: 宋体; ">穿越方案。如下图<br />&nbsp; &nbsp; &nbsp;<img src="http://www.cppblog.com/images/cppblog_com/range/10.jpg" width="539" height="170" alt="" /><br />&nbsp; &nbsp; &nbsp;</span></p><div style="padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; display: inline-block; "><div style="padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "><span style="font-size: 10.5pt; font-family: 宋体; ">&nbsp; &nbsp; 这些解决方案都需要</span><span lang="EN-US" style="font-size: 10.5pt; font-family: Calibri, sans-serif; ">STUN</span><span class="apple-style-span"><span style="font-size: 10.5pt; font-family: 宋体; color: black; ">（</span><span lang="EN-US" style="font-size: 10.5pt; font-family: Arial, sans-serif; color: black; ">Simple Traversal of User Datagram Protocol through Network Address Translators (NATs)</span><span style="font-size: 10.5pt; font-family: 宋体; color: black; ">，</span><span lang="EN-US" style="font-size: 10.5pt; font-family: Arial, sans-serif; color: black; ">NAT</span><span style="font-size: 10.5pt; font-family: 宋体; color: black; ">的</span><span lang="EN-US" style="font-size: 10.5pt; font-family: Arial, sans-serif; color: black; ">UDP</span><span style="font-size: 10.5pt; font-family: 宋体; color: black; ">简单穿越）</span></span><span style="font-size: 10.5pt; font-family: 宋体; ">协议帮助。STUN协议要求一台具有公网</span><span lang="EN-US" style="font-size: 10.5pt; font-family: Calibri, sans-serif; ">IP</span><span style="font-size: 10.5pt; font-family: 宋体; ">的主机帮助一台主机进行</span><span lang="EN-US" style="font-size: 10.5pt; font-family: Calibri, sans-serif; ">NAT</span><span style="font-size: 10.5pt; font-family: 宋体; ">类型的判断。<br />&nbsp; &nbsp;&nbsp;<img src="http://www.cppblog.com/images/cppblog_com/range/11.jpg" width="684" height="647" alt="" /></span></div></div><br />&nbsp; &nbsp; &nbsp;&nbsp;<span style="font-family: 宋体; ">上图是</span>STUN<span style="font-family: 宋体; ">协议的流程，其主要的思想是通过</span>STUN<span style="font-family: 宋体; ">的回射来判断主机的</span>NAT<span style="font-family: 宋体; ">类型。</span><div style="padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "><p style="margin-top: 5px; margin-right: auto; margin-bottom: 5px; margin-left: auto; text-indent: 0px; "><span style="font-family: 宋体; ">&nbsp; &nbsp; &nbsp;除了直接连接，反向连接、打洞和依赖都需要第三台主机的帮助。</span></p><p style="margin-top: 5px; margin-right: auto; margin-bottom: 5px; margin-left: auto; text-indent: 0px; "><span style="font-family: 宋体; ">&nbsp; &nbsp; &nbsp;在《</span>Characterization and Measurement of TCP Traversal through NATs and Firewalls<span style="font-family: 宋体; ">》一文中介绍了</span>TCP<span style="font-family: 宋体; ">穿越的方法。在</span>STUNT#2<span style="font-family: 宋体; ">方法中，第三台主机和两台需要连接的主机都有长连接，当一方需要发起来连接时，向第三台主机发请求，第三台主机向被请求的主机发送邀请，此时需要连接的主机都向对方发送</span>SYN<span style="font-family: 宋体; ">包，此时双方的防火墙都有了洞，只要有一方的</span>SYN<span style="font-family: 宋体; ">包到达对方主机，连接就会被建立。</span>Relay<span style="font-family: 宋体; ">方法需要耗费的代价太大，在</span>P2P<span style="font-family: 宋体; ">应用中一般会消极的处理双方都是对称</span>NAT<span style="font-family: 宋体; ">的情况。</span></p></div><br /><br /><br /><br /><br /><p style="margin-top: 5px; margin-right: auto; margin-bottom: 5px; margin-left: auto; text-indent: 0px; ">&nbsp;</p></div><img src ="http://www.cppblog.com/range/aggbug/151093.html" width = "1" height = "1" /><br><br><div align=right><a style="text-decoration:none;" href="http://www.cppblog.com/range/" target="_blank">Range</a> 2011-07-15 20:35 <a href="http://www.cppblog.com/range/archive/2011/07/15/151093.html#Feedback" target="_blank" style="text-decoration:none;">发表评论</a></div>
                                                                                                                          
                                                                                                                      
